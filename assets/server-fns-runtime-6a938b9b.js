import{createSignal as T,getOwner as F,getListener as D,onCleanup as W,startTransition as C,sharedConfig as R,createMemo as N,$TRACK as X}from"solid-js";import{isServer as h,getRequestEvent as b}from"solid-js/web";import{o as G,p as z,m as J,q as Q}from"./routing-3dcb2e42.js";import{provideRequestEvent as V}from"solid-js/web/storage";import{H3Event as _,setResponseStatus as Y,sendRedirect as Z,getCookie as ee,setCookie as te,setHeader as ne,getRequestIP as re,getResponseStatus as oe,getResponseStatusText as se,getRequestURL as ae,getResponseHeaders as ie,getResponseHeader as ce,setResponseHeader as ue,appendResponseHeader as fe,removeResponseHeader as le,getRequestWebStream as de}from"h3";import{AsyncLocalStorage as he}from"node:async_hooks";const ge="Location",pe=5e3,ye=18e4;let S=new Map;h||setInterval(()=>{const e=Date.now();for(let[t,n]of S.entries())!n[3].count&&e-n[0]>ye&&S.delete(t)},3e5);function q(){if(!h)return S;const e=b();if(!e)throw new Error("Cannot find cache context");return(e.router||(e.router={})).cache||(e.router.cache=new Map)}function me(e,t=!0){return C(()=>{const n=Date.now();M(e,r=>{t&&(r[0]=0),r[3][1](n)})})}function M(e,t){e&&!Array.isArray(e)&&(e=[e]);for(let n of S.keys())(e===void 0||we(n,e))&&t(S.get(n))}function O(e,t){e.GET&&(e=e.GET);const n=(...r)=>{const o=q(),s=z(),f=F()?G():void 0,g=Date.now(),l=t+H(r);let a=o.get(l),w;if(h){const c=b();if(c){const p=(c.router||(c.router={})).dataOnly;if(p){const y=c&&(c.router.data||(c.router.data={}));if(y&&l in y)return y[l];if(Array.isArray(p)&&!p.includes(l))return y[l]=void 0,Promise.resolve()}}}if(D()&&!h&&(w=!0,W(()=>a[3].count--)),a&&(h||s==="native"||a[0]&&a[3].count||Date.now()-a[0]<pe)){w&&(a[3].count++,a[3][0]()),a[2]==="preload"&&s!=="preload"&&(a[0]=g);let c=a[1];return s!=="preload"&&(c="then"in a[1]?a[1].then(m(!1),m(!0)):m(!1)(a[1]),!h&&s==="navigate"&&C(()=>a[3][1](a[0]))),c}let u=!h&&R.context&&R.has(l)?R.load(l):e(...r);if(a?(a[0]=g,a[1]=u,a[2]=s,!h&&s==="navigate"&&C(()=>a[3][1](a[0]))):(o.set(l,a=[g,u,s,T(g)]),a[3].count=0),w&&(a[3].count++,a[3][0]()),h){const c=b();return c&&c.router.dataOnly&&(c.router.data[l]=u),u}if(s!=="preload"&&(u="then"in u?u.then(m(!1),m(!0)):m(!1)(u)),h&&R.context&&R.context.async&&!R.context.noHydrate){const c=b();(!c||!c.serverOnly)&&R.context.serialize(l,u)}return u;function m(c){return async p=>{if(p instanceof Response){if(p.headers.has("Location")){f&&C(()=>{let y=p.headers.get(ge);y&&y.startsWith("/")?f(y,{replace:!0}):!h&&y&&(window.location.href=y)});return}p.customBody&&(p=await p.customBody())}if(c)throw p;return p}}};return n.keyFor=(...r)=>t+H(r),n.key=t,n}O.set=(e,t)=>{const n=q(),r=Date.now();let o=n.get(e);o?(o[0]=r,o[1]=t,o[2]="preload"):(n.set(e,o=[r,t,,T(r)]),o[3].count=0)};O.clear=()=>q().clear();function we(e,t){for(let n of t)if(e.startsWith(n))return!0;return!1}function H(e){return JSON.stringify(e,(t,n)=>Re(n)?Object.keys(n).sort().reduce((r,o)=>(r[o]=n[o],r),{}):n)}function Re(e){let t;return e!=null&&typeof e=="object"&&(!(t=Object.getPrototypeOf(e))||t===Object.prototype)}const $=new Map;function be(e,t){const n=Q(),r=N(()=>n.submissions[0]().filter(o=>o.url===e.toString()&&(!t||t(o.input))));return new Proxy([],{get(o,s){return s===X?r():s==="pending"?r().some(i=>!i.result):r()[s]}})}function Qe(e,t){const n=be(e,t);return new Proxy({},{get(r,o){return n[n.length-1]?.[o]}})}function Ve(e,t){function n(...o){const s=this,i=(s.singleFlight&&e.withOptions?e.withOptions({headers:{"X-Single-Flight":"true"}}):e)(...o),[f,g]=T();let l;async function a(w){const u=await ve(w,s.navigatorFactory());return u?g({data:u}):l.clear(),u}return s.submissions[1](w=>[...w,l={input:o,url:r,get result(){return f()?.data},get pending(){return!f()},clear(){s.submissions[1](u=>u.filter(m=>m.input!==o))},retry(){return g(void 0),e(...o).then(a,a)}}]),i.then(a,a)}const r=e.url||t&&`https://action/${t}`||(h?"":`https://action/${Se(e.toString())}`);return K(n,r)}function K(e,t){return e.toString=()=>{if(!t)throw new Error("Client Actions need explicit names if server rendered");return t},e.with=function(...n){const r=function(...s){return e.call(this,...n,...s)},o=new URL(t,J);return o.searchParams.set("args",H(n)),K(r,(o.origin==="https://action"?o.origin:"")+o.pathname+o.search)},e.url=t,h||($.set(t,e),F()&&W(()=>$.delete(t))),e}const Se=e=>e.split("").reduce((t,n)=>(t<<5)-t+n.charCodeAt(0)|0,0);async function ve(e,t){let n,r,o;if(e instanceof Response){if(e.headers.has("X-Revalidate")&&(r=o=e.headers.get("X-Revalidate").split(",")),e.customBody&&(n=await e.customBody(),e.headers.has("X-Single-Flight")&&(r||(r=[]),o||(o=[]),Object.keys(n).forEach(s=>{s!=="_$value"&&(r.push(s),O.set(s,n[s]))}),n=n._$value)),e.headers.has("Location")){const s=e.headers.get("Location")||"/";s.startsWith("http")?window.location.href=s:t(s)}}else n=e;return M(o,s=>s[0]=0),await me(r,!1),n}function xe(e={}){let t,n=!1;const r=i=>{if(t&&t!==i)throw new Error("Context conflict")};let o;if(e.asyncContext){const i=e.AsyncLocalStorage||globalThis.AsyncLocalStorage;i?o=new i:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const s=()=>{if(o&&t===void 0){const i=o.getStore();if(i!==void 0)return i}return t};return{use:()=>{const i=s();if(i===void 0)throw new Error("Context is not available");return i},tryUse:()=>s(),set:(i,f)=>{f||r(i),t=i,n=!0},unset:()=>{t=void 0,n=!1},call:(i,f)=>{r(i),t=i;try{return o?o.run(i,f):f()}finally{n||(t=void 0)}},async callAsync(i,f){t=i;const g=()=>{t=i},l=()=>t===i?g:void 0;U.add(l);try{const a=o?o.run(i,f):f();return n||(t=void 0),await a}finally{U.delete(l)}}}}function Ce(e={}){const t={};return{get(n,r={}){return t[n]||(t[n]=xe({...e,...r})),t[n],t[n]}}}const A=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof global<"u"?global:typeof window<"u"?window:{},L="__unctx__",Ae=A[L]||(A[L]=Ce()),Ee=(e,t={})=>Ae.get(e,t),P="__unctx_async_handlers__",U=A[P]||(A[P]=new Set);function _e(e){let t;const n=B(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...r,body:e.node.req.body}):new Request(n,{...r,get body(){return t||(t=Ue(e),t)}})}function He(e){return e.web??={request:_e(e),url:B(e)},e.web.request}function Te(){return Fe()}const v=Symbol("$HTTPEvent");function qe(e){return typeof e=="object"&&(e instanceof _||e?.[v]instanceof _||e?.__is_event__===!0)}function d(e){return function(...t){let n=t[0];if(qe(n))t[0]=n instanceof _||n.__is_event__?n:n[v];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(n=Te(),!n)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(n)}return e(...t)}}const B=d(ae),Oe=d(re),I=d(Y),j=d(oe),$e=d(se),x=d(ie),k=d(ce),Le=d(ue),Pe=d(fe),Ye=d(Z),Ze=d(ee),et=d(te),tt=d(ne),Ue=d(de),Ie=d(le),je=d(He);function ke(){return Ee("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:he})}function Fe(){return ke().use().event}const E=Symbol("fetchEvent");function We(e){return{request:je(e),response:Be(e),clientAddress:Oe(e),locals:{},nativeEvent:e,[v]:e}}function Me(e){return{...e,[v]:e[v]}}function nt(e){if(!e[E]){const t=We(e);e[E]=t}return e[E]}class Ke{constructor(t){this.event=t}get(t){const n=k(this.event,t);return Array.isArray(n)?n.join(", "):n}has(t){return this.get(t)!==void 0}set(t,n){return Le(this.event,t,n)}delete(t){return Ie(this.event,t)}append(t,n){Pe(this.event,t,n)}getSetCookie(){const t=k(this.event,"Set-Cookie");return Array.isArray(t)?t:[t]}forEach(t){return Object.entries(x(this.event)).forEach(([n,r])=>t(Array.isArray(r)?r.join(", "):r,n,this))}entries(){return Object.entries(x(this.event)).map(([t,n])=>[t,Array.isArray(n)?n.join(", "):n])[Symbol.iterator]()}keys(){return Object.keys(x(this.event))[Symbol.iterator]()}values(){return Object.values(x(this.event)).map(t=>Array.isArray(t)?t.join(", "):t)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function Be(e){return{get status(){return j(e)},set status(t){I(e,t)},get statusText(){return $e(e)},set statusText(t){I(e,j(),t)},headers:new Ke(e)}}function rt(e,t,n){if(typeof e!="function")throw new Error("Export from a 'use server' module must be a function");const r="/portfolio";return new Proxy(e,{get(o,s,i){if(s==="url")return`${r}/_server/?id=${encodeURIComponent(t)}&name=${encodeURIComponent(n)}`;if(s==="GET")return i},apply(o,s,i){const f=b();if(!f)throw new Error("Cannot call server function outside of a request");const g=Me(f);return g.serverOnly=!0,V(g,()=>e.apply(s,i))}})}export{$ as a,rt as b,O as c,nt as d,Ye as e,I as f,Ze as g,tt as h,Ve as i,et as s,Qe as u};
